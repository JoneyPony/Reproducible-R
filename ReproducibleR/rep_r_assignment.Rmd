---
title: "Reproducible Science and Figures in R Assignment"
output:
  pdf_document: default
  html_document: default
date: "2023-12-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(palmerpenguins)
library(ggplot2)
library(janitor)
library(dplyr)
library(lattice)
library(car)
```

*To create a PDF, first install tinytex and load the package. Then press the Knit arrow and select "Knit to PDF".*

## QUESTION 01: Data Visualisation for Science Communication

### a) My bad figure:

```{r Bad Figure Code, echo=FALSE}

ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = sex)) +
  theme_dark() +
  xlab('bill_len') + ylab('bill_dep') +
  geom_point() +
  scale_colour_manual(values = c('#1114B1', '#36298C')) +
  xlim(0,100)

```

### b) Write about how your design choices mislead the reader about the underlying data (200-300 words).

The difference in colour between female and male dots is small, making it difficult to distinguish them. The "NA" dots are the same colour as the background, making them invisible. This is not because the background and "NA" dots are specified to the same colour in the code; rather, it is because the default colour that "NA" dots are set to and the colour of the *dark* theme background in ggplot2 happen to be the same, which could possibly be overlooked when writing the code.

Additionally, the axis labels are abbreviated, from "bill_length_mm" and "bill_depth_mm" to "bill_len" and "bill_dep". This leaves it up to the reader to interpret the meaning of "len" as "length" and "dep" as "depth", which might not be obvious to them, especially, I would imagine, for "dep". Also, the abbreviation of the axis labels leaves out the units (mm), so the reader cannot tell the real value of any of the measurements. This is made worse by possibly not knowing what "len" or "dep" mean, and therefore not knowing how the x and y variables might possibly compare or interact.

The x axis scale is unreasonably wide, squashing the data points together in the x direction. This obscures the trend that male bill length is greater than female bill length on average, making it seem like male and female bill length are not significantly different, and leaves discernible only the trend that male bill depth is greater on average than female bill depth.

There is no title or caption giving context. Even with context, there is no mention or visual representation of the fact that the data points come from three different penguin species, not one species as might possibly be inferred without contradictory information.

## QUESTION 2: Data Pipeline

*Write a data analysis pipeline in your .rmd RMarkdown file. You should be aiming to write a clear explanation of the steps as well as clear code.*

*Your code should include the steps practiced in the lab session:*

-   *Load the data*

-   *Appropriately clean the data*

-   *Create an Exploratory Figure (**not a boxplot**)*

-   *Save the figure*

-   ***New**: Run a statistical test*

-   ***New**: Create a Results Figure*

-   *Save the figure*

*An exploratory figure shows raw data, such as the distribution of the data. A results figure demonstrates the stats method chosen, and includes the results of the stats test.*

*Between your code, communicate clearly what you are doing and why.*

*Your text should include:*

-   *Introduction*

-   *Hypothesis*

-   *Stats Method*

-   *Results*

-   *Discussion*

-   *Conclusion*

*You will be marked on the following:*

### a) Your code for readability and functionality

### b) Your figures for communication

### c) Your text communication of your analysis

*Below is a template you can use.*

------------------------------------------------------------------------

## INTRODUCTION

### 1. Cleaning the Data

I started by "cleaning" the DataFrame the data are stored in to make them easier to investigate and use. The full dataset in the "palmerpenguins" package -- "penguins_raw" -- contains columns that I would not need for any data analysis. Also, the column names are inconsistently punctuated, making them confusing to include in code, and some column names contain spaces, which is inconvenient for use in code, as incorrect syntax could result in the computer thinking one table column is two objects.

```{r Data Cleaning 1}

# head(penguins_raw)
names(penguins_raw)                   # Old column titles

```

I removed the columns that I would not need and standardised the column names so they are less confusing to use, including making sure there are no spaces.

```{r Data Cleaning 2}

penguins_clean <- penguins_raw %>%
  select(-starts_with("Delta")) %>%   # Removes columns starting with "Delta"
  select(-Comments) %>%               # Removes "Comments" column
  clean_names()                       # Standardises column titles

names(penguins_clean)                 # New column titles

```

### 2. Exploring the Data

To explore the data, I plotted matrices of scatter plots comparing the four continuous numeric measurements in the dataset: bill (culmen) length, bill (culmen) depth, flipper length, and body mass. Each scatter plot matrix groups the data points into colours by a different categorical measurement: species, sex, island, and year.

```{r Data Exploration 1}

# Checking the class of the different columns
sapply(penguins_clean, class)

# Columns 10:13 are numeric measurements.

# Making scatter plot matrices...

super.sym <- trellis.par.get("superpose.symbol")

# 1. ... by SPECIES:

splom(~penguins_clean[10:13], groups = species, data = penguins_clean,
      panel = panel.superpose, pscales=NULL,
      varnames = c("bill\nlength", "bill\ndepth", "flipper\nlength", "body\nmass"),
      pch = 20,
      key = list(title = "Penguin Species",
                 columns = 3,
                 points = list(pch = c(20,20,20),
                               col = super.sym$col[1:3]),
                 text = list(c("Adélie", "Chinstrap", "Gentoo"))))

# 2. ... by SEX:

splom(~penguins_clean[10:13], groups = sex, data = penguins_clean,
      panel = panel.superpose, pscales=NULL,
      varnames = c("bill\nlength", "bill\ndepth", "flipper\nlength", "body\nmass"),
      pch = 20,
      key = list(title = "Penguin Sex",
                 columns = 3,
                 points = list(pch = c(20,20),
                               col = super.sym$col[1:2]),
                 text = list(c("Female", "Male"))))

# 3. ... by ISLAND:

splom(~penguins_clean[10:13], groups = island, data = penguins_clean,
      panel = panel.superpose, pscales=NULL,
      varnames = c("bill\nlength", "bill\ndepth", "flipper\nlength", "body\nmass"),
      pch = 20,
      key = list(title = "Island",
                 columns = 3,
                 points = list(pch = c(20,20,20),
                               col = super.sym$col[1:3]),
                 text = list(c("Torgersen", "Biscoe", "Dream"))))

# 4. ... by YEAR:

splom(~penguins_clean[10:13], groups = format(date_egg, format = "%y"), data = penguins_clean,
      panel = panel.superpose, pscales=NULL,
      varnames = c("bill\nlength", "bill\ndepth", "flipper\nlength", "body\nmass"),
      pch = 20,
      key = list(title = "Year",
                 columns = 3,
                 points = list(pch = c(20,20,20),
                               col = super.sym$col[1:3]),
                 text = list(c("2007", "2008", "2009"))))

```

It seems that the data points are most distinctly grouped between species and sex. Differences between islands seem to coincide with differences between species (not all species were recorded on the same islands), and there appears to be little significant difference between different years across the other categorical variables.

The most interesting scatter plot to me was that of flipper length against body mass. I plotted a larger version of this graph to have a closer look.

```{r Data Exploration 2}

mass_len_plot <- ggplot(penguins_clean, aes(x = flipper_length_mm, y = body_mass_g, colour = species)) +
  geom_point() +
  labs(x = "Flipper Length (mm)", y = "Body Mass (g)", colour = "Penguin Species",
       title = "Exploring the Relationship between Flipper Length and Body Mass\nin Three Penguin Species") +
  scale_colour_discrete(labels=c("Adélie", "Chinstrap", "Gentoo")) +
  theme_linedraw()

mass_len_plot

```

Gentoos are grouped away from Adélies and chinstraps, which are mostly overlapping. Also, the gradient of the relationship between flipper length and body mass looks slightly steeper in gentoos than in Adélies and chinstraps, and might even be steeper in Adélies than in chinstraps. It would be interesting to see if the difference in the relationship between flipper length and body mass between the three penguin species is statistically significant.

### 3. Saving the Figure

Saving the above plot as a PNG file in the working directory:

```{r Data Exploration 3}

ggsave("mass_len_plot.png",
  plot = mass_len_plot,
  scale = 1,
  dpi = 300,
  height = 7, width = 9, unit = "in")

```

## HYPOTHESES

1. Body mass can be predicted from flipper length.

2. Mean body mass is different between species. 

3. The relationship between flipper length and body mass is different between species.

## STATISTICAL METHODS

To investigate the relationship between body mass, flipper length, and species, I plan on performing an ANCOVA -- *analysis of covariance* -- because I have a continuous response variable, body mass; a continuous explanatory variable (covariate), flipper length; and a categorical explanatory variable (factor), species.

The hypotheses above rephrased as the hypotheses being tested in an ANCOVA are:

*For x = flipper length and y = body mass,*

**Null hypotheses:**

1. There is no significant relationship between flipper length and body mass: the fitted gradient is 0 for all species.

2. There is no significant relationship between species and body mass: the mean body mass, and fitted y-intercept, is the same for all species. 

3. There is no interaction between flipper length and species: the fitted gradient is the same for all species.

**Alternative hypotheses:**

1. There is a significant relationship between flipper length and body mass: the fitted gradient is different from 0 in a given species.

2. There is a significant relationship between species and body mass: the mean body mass, and fitted y-intercept, is different between species.

3. There is an interaction between flipper length and species: the fitted gradients are different between species.

### Testing the ANCOVA's assumptions

An ANCOVA has assumptions that must be met for its results to hold. These are:

1. A linear relationship between the two continuous variables.

2. Normally distributed residuals.

3. Constant variance of residuals (*homoscedasticity*).

I created an ANCOVA model for the data and tested whether the data fit the ANCOVA's assumptions. I took the first assumption to be true from the graph I plotted. I tested the other two assumptions with a Shapiro-Wilk test for the normality assumption and Levene's test for the homoscedasticity assumption. These assumptions did not hold for the data if they were not transformed or if they were log-transformed, but if they were square root-transformed, both assumptions held.

```{r Statistics}

# ANCOVA model:

model <- lm(body_mass_g ~ species * flipper_length_mm, data = penguins_clean)

# Testing normality of residuals:

hist(model$residuals)
# Looks pretty normal.

qqPlot(model$residuals)
# Straying from normal at the far end.

shapiro.test(model$residuals)
# p = 0.03465 < 0.05, so NOT significantly similar to normal distribution.

# Testing homoscedasticity:

leveneTest(body_mass_g ~ species, data = penguins_clean)
# p = 0.006445 < 0.05, so variances NOT significantly similar.

# New model with SQUARE ROOT-TRANSFORMED data:

model_sqrt <- lm(sqrt(body_mass_g) ~ species * flipper_length_mm, data = penguins_clean)

hist(model_sqrt$residuals)
# Looks pretty normal.

qqPlot(model_sqrt$residuals)
# Looks pretty normal.

shapiro.test(model_sqrt$residuals)
# p = 0.4305 > 0.05, so significantly similar to normal distribution!

leveneTest(sqrt(body_mass_g) ~ species, data = penguins_clean)
# p = 0.06665 > 0.05, so variances significantly similar!

# New model with LOG-TRANSFORMED data:

model_log <- lm(log(body_mass_g) ~ species * flipper_length_mm, data = penguins_clean)

hist(model_log$residuals)
# Looks pretty normal.

qqPlot(model_log$residuals)
# Looks pretty normal.

shapiro.test(model_log$residuals)
# p = 0.7411 > 0.05, so significantly similar to normal distribution!

leveneTest(log(body_mass_g) ~ species, data = penguins_clean)
# p = 0.01672 < 0.05, so variances NOT significantly similar.

```

## RESULTS & DISCUSSION

### ANCOVA Results

I compared the results of my model with untransformed data and my model with square root-transformed data.

***Untransformed data model:***

```{r Results 1}

summary(model)

```

***Square root-transformed data model:***

```{r Results 2}

summary(model_sqrt)

```

### Terms of the Models

1. The y-intercept term for Adélie penguins -- **"(Intercept)"** -- is significantly different from 0 in the untransformed model (p = 0.00419 < 0.05) but is *not* significantly different from 0 in the square root-transformed model (p = 0.1602 > 0.05), which I do not think I have to be worried about as the y-intercept is quite close to 0 in this latter model (9.67775). A y-intercept equalling 0 is not a sign of nothing happening like a gradient equalling 0 is.

2. The difference in y-intercept between Adélies and chinstraps -- **"speciesChinstrap penguin (Pygoscelis antarctica)"** -- is not significant in either model (p = 0.74229 > 0.05 and p = 0.7624 > 0.05). Thus, body mass is not significantly different between Adélies and chinstraps.

*2nd null hypothesis NOT rejected with respect to Adélies and chinstraps.*

3. The difference in y-intercept between Adélies and gentoos -- **"speciesGentoo penguin (Pygoscelis papua)"** -- is significant in the untransformed model (p = 0.00311 < 0.05) and *just* insignificant in the square root-transformed model (p = 0.7624 > 0.05). Thus, body mass may be significantly different between Adélies and gentoos.

*2nd null hypothesis REJECTED with respect to Adélies and gentoos.*

4. The gradient term for the regression line between the y-variable and the x-variable flipper length in Adélies -- **"flipper_length_mm"** -- is significantly different from 0 in both models (p = 7.69x10^-12 << 0.05 and p = 9.23x10^-13 << 0.05). Thus, body mass can be predicted from flipper length.

*1st null hypothesis REJECTED.*

5. The difference in gradient between Adélies and chinstrapss -- **"speciesChinstrap penguin (Pygoscelis antarctica):flipper_length_mm"** -- is not significant in both models (p = 0.82467 > 0.05 and p = > 0.05). Thus, the relationship between flipper length and body mass is not significantly different between Adélies and chinstraps.

*3rd null hypothesis NOT rejected with respect to Adélies and chinstraps.*

6. The difference in gradient between Adélies and gentoos -- **"speciesGentoo penguin (Pygoscelis papua):flipper_length_mm"** -- is significant in both models (p = 0.00184 < 0.05 and p = 0.0346 < 0.05). Thus, the relationship between flipper length and body mass is significantly different between Adélies and gentoos.

*3rd null hypothesis REJECTED with respect to Adélies and gentoos.*

### Plotting the Results

To illustrate the regression models visually against the data, I plotted scatter plots, as above, with the addition of regression lines for each species for the untransformed and square root-transformed models.

```{r Results 3}

# Graph of flipper length against body mass for the three penguin species:

results_plot_unt <- ggplot(penguins_clean,
                           aes(x = flipper_length_mm, y = body_mass_g, colour = species)) +
  geom_point() +
  labs(x = "Flipper Length (mm)", y = "Body Mass (g)", colour = "Penguin Species",
       title = "Linear Regression of Flipper Length and Body Mass by Penguin Species",
       caption = "Regression lines with 95% confidence intervals") +
  scale_colour_discrete(labels=c("Adélie", "Chinstrap", "Gentoo")) +
  theme_linedraw() +
  geom_smooth(method = lm)          # Adding a regression line for each species.

results_plot_unt

# Graph of flipper length against sqrt(body mass) for the three penguin species:

results_plot_sqrt <- ggplot(penguins_clean,
                            aes(x = flipper_length_mm, y = sqrt(body_mass_g), colour = species)) +
  geom_point() +
  labs(x = "Flipper Length (mm)", y = "SQRT( Body Mass (g) )", colour = "Penguin Species",
       title = "Linear Regression of Flipper Length and Square Root of Body Mass\nby Penguin Species",
       caption = "Regression lines with 95% confidence intervals") +
  scale_colour_discrete(labels=c("Adélie", "Chinstrap", "Gentoo")) +
  theme_linedraw() +
  geom_smooth(method = lm)          # Adding a regression line for each species.

results_plot_sqrt

```

Saving these two figures as PNG files in the working directory:

```{r Saving Results}

ggsave("results_plot_unt.png",
  plot = results_plot_unt,
  scale = 1,
  dpi = 300,
  height = 7, width = 9, unit = "in")

ggsave("results_plot_sqrt.png",
  plot = results_plot_sqrt,
  scale = 1,
  dpi = 300,
  height = 7, width = 9, unit = "in")

```

### Discussion

In the analysis, comparison is made between Adélie penguins and chinstrap penguins and between Adélie penguins and gentoo penguins, but not between chinstrap penguins and gentoo penguins. Nevertheless, I think the conclusion of significantly different regression intercepts and slopes can be very reasonably extended to chinstraps and gentoos (rejection of the 2nd and 3rd null hypotheses with respect to those two species). If the regression model is not significantly different for chinstraps and Adélies, but it is significantly different for Adélies and gentoos, then reasonably it is different between chinstraps and gentoos. Also, the difference in mean flipper length and in the slope of the regression line are quite evident from the graph above.

## CONCLUSION

There is a linear relationship between flipper length and body mass in all three species of *Pygoscelis* penguins. The relationship between flipper length and body mass is not reliably significantly different between Adélie penguins and chinstrap penguins, but the relationship is significantly different between the latter two species and gentoo penguins.

The body mass of *Pygoscelis* penguins could be estimated quite reliably from their flipper length, and vice versa. In situations where researchers wish to measure both variables but can only easily measure one, the other could be estimated using a regression model. This model would be different for gentoo penguins than for Adélie penguins and chinstrap penguins, but the same model could potentially be reliably used for both Adélie penguins and chinstrap penguins. I doubt that using the same model for Adélies and chinstraps would be reliable enough, however, as there is a slight, if not reliably significant, difference between them.

## QUESTION 3: Open Science

### a) GitHub

*Upload your RProject you created for **Question 2** and any files and subfolders used to GitHub. Do not include any identifiers such as your name. Make sure your GitHub repo is public.*

*GitHub link:*

*You will be marked on your repo organisation and readability.*

### b) Share your repo with a partner, download, and try to run their data pipeline.

*Partner's GitHub link:*

*You **must** provide this so I can verify there is no plagiarism between you and your partner.*

### c) Reflect on your experience running their code. (300-500 words)

-   *What elements of your partner's code helped you to understand their data pipeline?*

-   *Did it run? Did you need to fix anything?*

-   *What suggestions would you make for improving their code to make it more understandable or reproducible, and why?*

-   *If you needed to alter your partner's figure using their code, do you think that would be easy or difficult, and why?*

### d) Reflect on your own code based on your experience with your partner's code and their review of yours. (300-500 words)

-   *What improvements did they suggest, and do you agree?*

-   *What did you learn about writing code for other people?*
